<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PVME Tracker">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23d4af37' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='%231a1a2e'>üì∏</text></svg>">
    <title>PVME Picture Day Tracker</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        
        input, select, button {
            font-family: inherit;
        }
        
        input[type="checkbox"] {
            width: 24px;
            height: 24px;
            accent-color: #eab308;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // ============ CONFIGURATION ============
        const CONFIG = {
            apiKey: 'af081af2c96a9cbb9b8e122986b113b5',
            formId: '253004946489061',
            taxRate: 0.06
        };

        const PACKAGES = {
            'A': { name: 'Package A', desc: '8√ó12 Class Group + 8√ó10 Individual', price: 25, needsPhoto: true },
            'B': { name: 'Package B', desc: '8√ó12 Class Group', price: 20, needsPhoto: false },
            'C': { name: 'Package C', desc: '8√ó10 Individual', price: 20, needsPhoto: true },
            'D': { name: 'Package D', desc: '8√ó10 Buddy Shot', price: 20, needsPhoto: true },
            'G1': { name: 'Package G1', desc: 'Mouse Pad', price: 15, needsPhoto: true },
            'G2': { name: 'Package G2', desc: 'Phone Socket Grip', price: 15, needsPhoto: true },
            'G3': { name: 'Package G3', desc: 'Dog Tag (Photo)', price: 15, needsPhoto: true },
            'G4': { name: 'Package G4', desc: 'Bag Tag (3) Double-Sided', price: 30, needsPhoto: true },
            'G5': { name: 'Package G5', desc: 'Bag Tag (1) Double-Sided', price: 12, needsPhoto: true },
            'G6': { name: 'Package G6', desc: '11oz Mug (Full Wrap)', price: 15, needsPhoto: true },
            'G7': { name: 'Package G7', desc: '14oz Deluxe Travel Mug', price: 30, needsPhoto: true }
        };

        // ============ MAIN APP ============
        function App() {
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [view, setView] = useState('shoot');
            const [expandedOrder, setExpandedOrder] = useState(null);
            
            // Filters
            const [dayFilter, setDayFilter] = useState('all');
            const [platoonFilter, setPlatoonFilter] = useState('all');
            const [statusFilter, setStatusFilter] = useState('all');
            const [searchQuery, setSearchQuery] = useState('');
            
            // Local data persisted to localStorage
            const [localData, setLocalData] = useState(() => {
                try {
                    const saved = localStorage.getItem('pvme_tracker_data');
                    return saved ? JSON.parse(saved) : {};
                } catch {
                    return {};
                }
            });

            // Save to localStorage whenever localData changes
            useEffect(() => {
                try {
                    localStorage.setItem('pvme_tracker_data', JSON.stringify(localData));
                } catch (e) {
                    console.error('Failed to save:', e);
                }
            }, [localData]);

            const parseOrders = (submissions) => {
                return submissions.map(sub => {
                    const answers = sub.answers || {};
                    let name = '', platoon = '', drillSergeant = '', pictureDay = '',
                        packages = [], buddyName = '', email = '', customRequest = '',
                        orderTotal = 0, graduationDate = '';

                    Object.keys(answers).forEach(key => {
                        const answer = answers[key];
                        const text = answer.text || '';
                        const value = answer.answer || '';

                        if (text.includes('Full Name')) name = value;
                        else if (text.includes('Platoon')) platoon = value;
                        else if (text.includes('Drill Sergeant')) drillSergeant = value;
                        else if (text.includes('Picture Day')) pictureDay = value;
                        else if (text.includes('packages you want')) {
                            packages = Array.isArray(value) ? value : (value ? [value] : []);
                        }
                        else if (text.includes('Buddy')) buddyName = value;
                        else if (text.includes('Email')) email = value;
                        else if (text.includes('custom request')) customRequest = value;
                        else if (text.includes('Order Total')) orderTotal = parseFloat(value) || 0;
                        else if (text.includes('Graduate')) graduationDate = value;
                    });

                    const parsedPackages = packages.map(pkg => {
                        const match = pkg.match(/^([A-Z]\d?)/);
                        if (match) {
                            const code = match[1];
                            return { code, raw: pkg, ...PACKAGES[code] };
                        }
                        return null;
                    }).filter(p => p && p.name);

                    const subtotal = parsedPackages.reduce((sum, p) => sum + (p.price || 0), 0);
                    const tax = subtotal * CONFIG.taxRate;
                    const calculatedTotal = subtotal + tax;

                    return {
                        id: sub.id,
                        name,
                        platoon,
                        drillSergeant,
                        pictureDay,
                        packages: parsedPackages,
                        buddyName,
                        email,
                        customRequest,
                        orderTotal: orderTotal || calculatedTotal,
                        subtotal,
                        tax,
                        graduationDate,
                        createdAt: sub.created_at
                    };
                }).filter(o => o.name && o.packages.length > 0);
            };

            const loadOrders = async () => {
                setLoading(true);
                setError(null);
                
                try {
                    const response = await fetch(
                        `https://api.jotform.com/form/${CONFIG.formId}/submissions?apiKey=${CONFIG.apiKey}&limit=1000`
                    );
                    const data = await response.json();
                    
                    if (data.responseCode === 200) {
                        const parsed = parseOrders(data.content);
                        setOrders(parsed);
                    } else {
                        setError('Failed to load: ' + (data.message || 'Unknown error'));
                    }
                } catch (err) {
                    setError('Connection error: ' + err.message);
                }
                
                setLoading(false);
            };

            useEffect(() => {
                loadOrders();
            }, []);

            // Filter orders
            const filteredOrders = orders.filter(order => {
                if (dayFilter !== 'all' && order.pictureDay !== dayFilter) return false;
                if (platoonFilter !== 'all' && order.platoon !== platoonFilter) return false;
                const isCompleted = localData[order.id]?.completed;
                if (statusFilter === 'pending' && isCompleted) return false;
                if (statusFilter === 'completed' && !isCompleted) return false;
                if (searchQuery && !order.name.toLowerCase().includes(searchQuery.toLowerCase())) return false;
                return true;
            }).sort((a, b) => a.name.localeCompare(b.name));

            const pictureDays = [...new Set(orders.map(o => o.pictureDay).filter(d => d))].sort();
            const platoons = [...new Set(orders.map(o => o.platoon).filter(p => p))].sort();

            const updatePhotoNumber = (orderId, pkgCode, value) => {
                setLocalData(prev => ({
                    ...prev,
                    [orderId]: {
                        ...prev[orderId],
                        photoNumbers: {
                            ...(prev[orderId]?.photoNumbers || {}),
                            [pkgCode]: value
                        }
                    }
                }));
            };

            const toggleComplete = (orderId) => {
                setLocalData(prev => ({
                    ...prev,
                    [orderId]: {
                        ...prev[orderId],
                        completed: !prev[orderId]?.completed
                    }
                }));
            };

            const getPhotoNumber = (orderId, pkgCode) => {
                return localData[orderId]?.photoNumbers?.[pkgCode] || '';
            };

            const isCompleted = (orderId) => {
                return localData[orderId]?.completed || false;
            };

            const stats = {
                total: orders.length,
                filtered: filteredOrders.length,
                completed: filteredOrders.filter(o => isCompleted(o.id)).length,
                pending: filteredOrders.filter(o => !isCompleted(o.id)).length,
                revenue: filteredOrders.reduce((sum, o) => sum + o.orderTotal, 0)
            };

            const exportCSV = () => {
                const rows = filteredOrders.map(o => {
                    const photoNums = Object.entries(localData[o.id]?.photoNumbers || {})
                        .filter(([k, v]) => v)
                        .map(([k, v]) => `${k}:${v}`).join('; ');
                    return [
                        o.name,
                        o.platoon,
                        o.pictureDay,
                        o.packages.map(p => p.code).join(', '),
                        photoNums,
                        o.orderTotal.toFixed(2),
                        isCompleted(o.id) ? 'Yes' : 'No',
                        o.buddyName,
                        o.email
                    ].map(v => `"${v || ''}"`).join(',');
                });
                
                const csv = ['Name,Platoon,PictureDay,Packages,PhotoNumbers,Total,Completed,BuddyName,Email', ...rows].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pvme_orders_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const clearData = () => {
                if (confirm('Clear all photo numbers and completion status? This cannot be undone.')) {
                    setLocalData({});
                    localStorage.removeItem('pvme_tracker_data');
                }
            };

            // Styles
            const styles = {
                header: {
                    background: 'linear-gradient(135deg, #ca8a04 0%, #a16207 100%)',
                    color: '#0f172a',
                    padding: '16px',
                    position: 'sticky',
                    top: 0,
                    zIndex: 100
                },
                title: {
                    fontSize: '20px',
                    fontWeight: 'bold',
                    marginBottom: '4px'
                },
                subtitle: {
                    fontSize: '12px',
                    opacity: 0.8
                },
                btnGroup: {
                    display: 'flex',
                    gap: '8px',
                    marginTop: '12px',
                    flexWrap: 'wrap'
                },
                btn: {
                    background: '#0f172a',
                    color: '#eab308',
                    border: 'none',
                    padding: '10px 16px',
                    borderRadius: '8px',
                    fontSize: '13px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px'
                },
                statsBar: {
                    display: 'flex',
                    gap: '16px',
                    padding: '12px 16px',
                    background: '#1e293b',
                    borderBottom: '1px solid #334155',
                    overflowX: 'auto'
                },
                stat: {
                    textAlign: 'center',
                    minWidth: '60px'
                },
                statValue: {
                    fontSize: '20px',
                    fontWeight: 'bold',
                    color: '#eab308'
                },
                statLabel: {
                    fontSize: '10px',
                    color: '#64748b',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                },
                filters: {
                    padding: '12px 16px',
                    background: '#1e293b',
                    display: 'flex',
                    gap: '8px',
                    flexWrap: 'wrap',
                    alignItems: 'center',
                    borderBottom: '1px solid #334155'
                },
                select: {
                    background: '#0f172a',
                    border: '1px solid #334155',
                    color: '#e2e8f0',
                    padding: '8px 12px',
                    borderRadius: '6px',
                    fontSize: '13px'
                },
                searchInput: {
                    background: '#0f172a',
                    border: '1px solid #334155',
                    color: '#e2e8f0',
                    padding: '8px 12px',
                    borderRadius: '6px',
                    fontSize: '13px',
                    flex: 1,
                    minWidth: '120px'
                },
                viewToggle: {
                    display: 'flex',
                    borderRadius: '6px',
                    overflow: 'hidden',
                    border: '1px solid #334155'
                },
                viewBtn: (active) => ({
                    padding: '8px 14px',
                    background: active ? '#eab308' : '#0f172a',
                    color: active ? '#0f172a' : '#94a3b8',
                    border: 'none',
                    cursor: 'pointer',
                    fontSize: '12px',
                    fontWeight: '600'
                }),
                ordersList: {
                    padding: '16px',
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '12px'
                },
                orderCard: (completed) => ({
                    background: '#1e293b',
                    borderRadius: '12px',
                    border: `1px solid ${completed ? '#22c55e' : '#334155'}`,
                    opacity: completed ? 0.7 : 1,
                    overflow: 'hidden'
                }),
                orderHeader: {
                    padding: '14px 16px',
                    cursor: 'pointer',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'flex-start'
                },
                orderName: {
                    fontSize: '16px',
                    fontWeight: '600'
                },
                badge: (type) => ({
                    display: 'inline-block',
                    padding: '2px 8px',
                    borderRadius: '12px',
                    fontSize: '10px',
                    fontWeight: '600',
                    marginLeft: '8px',
                    background: type === 'done' ? '#22c55e' : '#eab308',
                    color: type === 'done' ? '#fff' : '#0f172a'
                }),
                orderMeta: {
                    display: 'flex',
                    gap: '12px',
                    fontSize: '12px',
                    color: '#64748b',
                    marginTop: '4px',
                    flexWrap: 'wrap'
                },
                orderTotal: {
                    fontSize: '18px',
                    fontWeight: 'bold',
                    color: '#eab308'
                },
                orderBody: {
                    padding: '0 16px 16px',
                    borderTop: '1px solid #334155'
                },
                packageItem: {
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    padding: '12px 0',
                    borderBottom: '1px solid #334155'
                },
                packageInfo: {
                    flex: 1
                },
                packageName: {
                    fontWeight: '600',
                    fontSize: '14px'
                },
                packageDesc: {
                    fontSize: '11px',
                    color: '#64748b'
                },
                packagePrice: {
                    color: '#eab308',
                    fontWeight: '600',
                    minWidth: '50px',
                    textAlign: 'right'
                },
                photoInput: {
                    width: '70px',
                    padding: '6px 8px',
                    background: '#0f172a',
                    border: '2px solid #eab308',
                    borderRadius: '6px',
                    color: '#fff',
                    fontSize: '14px',
                    fontWeight: '600',
                    textAlign: 'center'
                },
                noPhoto: {
                    fontSize: '10px',
                    color: '#475569',
                    width: '70px',
                    textAlign: 'center'
                },
                buddyBox: {
                    background: '#0f172a',
                    padding: '10px 12px',
                    borderRadius: '6px',
                    marginTop: '12px'
                },
                buddyLabel: {
                    fontSize: '10px',
                    color: '#64748b',
                    textTransform: 'uppercase',
                    marginBottom: '4px'
                },
                completeBtn: (done) => ({
                    width: '100%',
                    padding: '14px',
                    marginTop: '12px',
                    background: done ? '#475569' : '#22c55e',
                    color: '#fff',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '15px',
                    fontWeight: '600',
                    cursor: 'pointer'
                }),
                deliveryCard: {
                    background: '#1e293b',
                    borderRadius: '12px',
                    padding: '16px',
                    border: '1px solid #334155'
                },
                emptyState: {
                    textAlign: 'center',
                    padding: '60px 20px',
                    color: '#64748b'
                }
            };

            return (
                <div>
                    {/* Header */}
                    <div style={styles.header}>
                        <div style={styles.title}>üì∏ PVME Picture Day Tracker</div>
                        <div style={styles.subtitle}>Pro Vision Multimedia Enterprises ‚Äî "We Got You"</div>
                        <div style={styles.btnGroup}>
                            <button style={styles.btn} onClick={loadOrders} disabled={loading}>
                                {loading ? '‚è≥' : 'üîÑ'} {loading ? 'Loading...' : 'Refresh'}
                            </button>
                            <button style={styles.btn} onClick={exportCSV}>
                                üìã Export
                            </button>
                            <button style={{...styles.btn, background: '#7f1d1d', color: '#fca5a5'}} onClick={clearData}>
                                üóëÔ∏è Clear
                            </button>
                        </div>
                    </div>

                    {/* Stats */}
                    <div style={styles.statsBar}>
                        {[
                            { label: 'Total', value: stats.total },
                            { label: 'Showing', value: stats.filtered },
                            { label: 'Done', value: stats.completed },
                            { label: 'Pending', value: stats.pending },
                            { label: 'Revenue', value: `$${stats.revenue.toFixed(0)}` }
                        ].map(s => (
                            <div key={s.label} style={styles.stat}>
                                <div style={styles.statValue}>{s.value}</div>
                                <div style={styles.statLabel}>{s.label}</div>
                            </div>
                        ))}
                    </div>

                    {/* Filters */}
                    <div style={styles.filters}>
                        <select style={styles.select} value={dayFilter} onChange={e => setDayFilter(e.target.value)}>
                            <option value="all">All Days</option>
                            {pictureDays.map(d => <option key={d} value={d}>{d}</option>)}
                        </select>
                        
                        <select style={styles.select} value={platoonFilter} onChange={e => setPlatoonFilter(e.target.value)}>
                            <option value="all">All Platoons</option>
                            {platoons.map(p => <option key={p} value={p}>{p}</option>)}
                        </select>
                        
                        <select style={styles.select} value={statusFilter} onChange={e => setStatusFilter(e.target.value)}>
                            <option value="all">All</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Done</option>
                        </select>
                        
                        <input
                            type="text"
                            placeholder="Search..."
                            style={styles.searchInput}
                            value={searchQuery}
                            onChange={e => setSearchQuery(e.target.value)}
                        />
                        
                        <div style={styles.viewToggle}>
                            <button style={styles.viewBtn(view === 'shoot')} onClick={() => setView('shoot')}>Shoot</button>
                            <button style={styles.viewBtn(view === 'delivery')} onClick={() => setView('delivery')}>Delivery</button>
                        </div>
                    </div>

                    {/* Error */}
                    {error && (
                        <div style={{margin: '16px', padding: '16px', background: '#7f1d1d', borderRadius: '8px', color: '#fca5a5'}}>
                            {error}
                            <button onClick={loadOrders} style={{marginLeft: '12px', color: '#eab308', background: 'none', border: 'none', textDecoration: 'underline', cursor: 'pointer'}}>
                                Try Again
                            </button>
                        </div>
                    )}

                    {/* Orders */}
                    <div style={styles.ordersList}>
                        {loading && orders.length === 0 ? (
                            <div style={styles.emptyState}>
                                <div style={{fontSize: '40px', marginBottom: '16px'}}>‚è≥</div>
                                <div>Loading orders from Jotform...</div>
                            </div>
                        ) : filteredOrders.length === 0 ? (
                            <div style={styles.emptyState}>
                                <div style={{fontSize: '40px', marginBottom: '16px'}}>üì≠</div>
                                <div>No orders found</div>
                            </div>
                        ) : view === 'shoot' ? (
                            filteredOrders.map(order => (
                                <div key={order.id} style={styles.orderCard(isCompleted(order.id))}>
                                    <div style={styles.orderHeader} onClick={() => setExpandedOrder(expandedOrder === order.id ? null : order.id)}>
                                        <div>
                                            <div>
                                                <span style={styles.orderName}>{order.name}</span>
                                                <span style={styles.badge(isCompleted(order.id) ? 'done' : 'pending')}>
                                                    {isCompleted(order.id) ? '‚úì Done' : 'Pending'}
                                                </span>
                                            </div>
                                            <div style={styles.orderMeta}>
                                                <span>üìÖ {order.pictureDay || 'No date'}</span>
                                                <span>üéñÔ∏è {order.platoon || 'N/A'}</span>
                                                <span>üì¶ {order.packages.length}</span>
                                            </div>
                                        </div>
                                        <div style={styles.orderTotal}>${order.orderTotal.toFixed(2)}</div>
                                    </div>
                                    
                                    {expandedOrder === order.id && (
                                        <div style={styles.orderBody}>
                                            {order.packages.map(pkg => (
                                                <div key={pkg.code} style={styles.packageItem}>
                                                    <input
                                                        type="checkbox"
                                                        checked={!!getPhotoNumber(order.id, pkg.code)}
                                                        onChange={() => {}}
                                                    />
                                                    <div style={styles.packageInfo}>
                                                        <div style={styles.packageName}>{pkg.name}</div>
                                                        <div style={styles.packageDesc}>{pkg.desc}</div>
                                                    </div>
                                                    <div style={styles.packagePrice}>${pkg.price}</div>
                                                    {pkg.needsPhoto ? (
                                                        <input
                                                            type="text"
                                                            placeholder="#"
                                                            style={styles.photoInput}
                                                            value={getPhotoNumber(order.id, pkg.code)}
                                                            onChange={e => updatePhotoNumber(order.id, pkg.code, e.target.value)}
                                                        />
                                                    ) : (
                                                        <div style={styles.noPhoto}>No photo</div>
                                                    )}
                                                </div>
                                            ))}
                                            
                                            {order.buddyName && (
                                                <div style={styles.buddyBox}>
                                                    <div style={styles.buddyLabel}>Buddy / DS Name</div>
                                                    <div>{order.buddyName}</div>
                                                </div>
                                            )}
                                            
                                            {order.customRequest && (
                                                <div style={{...styles.buddyBox, marginTop: '8px'}}>
                                                    <div style={styles.buddyLabel}>Custom Request</div>
                                                    <div style={{fontSize: '13px'}}>{order.customRequest}</div>
                                                </div>
                                            )}
                                            
                                            <button
                                                style={styles.completeBtn(isCompleted(order.id))}
                                                onClick={() => toggleComplete(order.id)}
                                            >
                                                {isCompleted(order.id) ? '‚Ü©Ô∏è Mark Incomplete' : '‚úì Mark Complete'}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            ))
                        ) : (
                            filteredOrders.map(order => {
                                const photoNums = Object.entries(localData[order.id]?.photoNumbers || {})
                                    .filter(([k, v]) => v)
                                    .map(([k, v]) => `${k}: ${v}`)
                                    .join(', ');
                                
                                return (
                                    <div key={order.id} style={styles.deliveryCard}>
                                        <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '8px'}}>
                                            <div>
                                                <div style={{fontSize: '16px', fontWeight: '600'}}>{order.name}</div>
                                                <div style={{fontSize: '12px', color: '#64748b'}}>{order.platoon}</div>
                                            </div>
                                            <div style={{fontSize: '22px', fontWeight: 'bold', color: '#eab308'}}>
                                                ${order.orderTotal.toFixed(2)}
                                            </div>
                                        </div>
                                        <div style={{fontSize: '12px', color: '#94a3b8'}}>
                                            {order.packages.map(p => p.code).join(', ')}
                                        </div>
                                        {photoNums && (
                                            <div style={{marginTop: '8px', paddingTop: '8px', borderTop: '1px solid #334155', fontSize: '12px'}}>
                                                <span style={{color: '#eab308', fontWeight: '600'}}>Photos:</span> {photoNums}
                                            </div>
                                        )}
                                    </div>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
